'use strict'
const fs = require('fs'),
  path = require('path'),
  jsonRender = require('json-templater/string'),
  uppercamelcase = require('uppercamelcase'),
  endOfLine = require('os').EOL,
  componentsList = require('../../components.json'),
  OUTPUT_PATH = path.join(__dirname, '../../packages/index.js')

const MAIN_TEMPLATE = `/* Automatically generated by './build/bin/build-entry.js' */

{{include}}

const components = [
{{install}},
]

const install = (app, opts = {}) => {
  components.forEach(item => {
    app.component(item.name, item)
  })

  app.$AXE = {
    size: opts.size || '',
    zIndex: opts.zIndex || 1000
  }
}

export default {
  version: '{{version}}',
  install,
{{export}},
}
`,
  IMPORT_TEMPLATE = `import {{nameCameraCase}} from './{{name}}/'`

const componentNames = Object.keys(componentsList),
  includeTempList = [],
  installTempList = [],
  exportTempList = []
componentNames.forEach(compItemName => {
  const AxeCompCameraName = 'Axe' + uppercamelcase(compItemName)
  includeTempList.push(
    jsonRender(IMPORT_TEMPLATE, {
      name: compItemName,
      nameCameraCase: AxeCompCameraName
    })
  )
  installTempList.push(`  ${AxeCompCameraName}`)
  exportTempList.push(`  ${AxeCompCameraName}`)
})

const template = jsonRender(MAIN_TEMPLATE, {
  include: includeTempList.join(endOfLine),
  install: installTempList.join(',' + endOfLine),
  export: exportTempList.join(',' + endOfLine),
  version: process.env.VERSION || require('../../package.json').version
})

fs.writeFileSync(OUTPUT_PATH, template)
// DONE
console.log('ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ä¸éª—ä½ ï¼Œè¿™æ¬¡æ˜¯çœŸçš„å®Œäº†~ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰')
console.log('[build entry] DONE:', OUTPUT_PATH)
